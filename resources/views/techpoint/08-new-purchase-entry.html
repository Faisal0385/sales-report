<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Portal</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Using Inter as the default font */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Custom transition for a smoother feel */
        .page {
            transition: opacity 0.3s ease-in-out;
        }

        /* Success message styling */
        .success-message {
            transition: opacity 0.5s, transform 0.5s;
        }

        /* Camera Modal Styling */
        #camera-modal {
            background-color: rgba(0, 0, 0, 0.8);
        }
    </style>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div class="w-full max-w-5xl p-4">

        <!-- =================================== -->
        <!--  8. New Purchase Entry Page        -->
        <!-- =================================== -->
        <div id="page-purchase-entry" class="page text-left">
            <!-- Page Header -->
            <div class="bg-gray-800 border-b border-gray-700 rounded-t-lg p-4 flex justify-between items-center mb-6">
                <div class="flex items-center">
                    <button onclick="showPage('page-buy-products-subcategory')"
                        class="text-gray-400 hover:text-white transition mr-4 p-1 rounded-full hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <div>
                        <h1 class="text-xl font-bold flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                class="w-5 h-5 mr-2 text-purple-400">
                                <path
                                    d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                            </svg>
                            New Purchase Entry
                        </h1>
                        <p id="purchase-entry-subtitle" class="text-sm text-gray-400"></p>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column: Form -->
                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-lg border border-gray-700">
                    <form onsubmit="handlePurchaseEntry(event)" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="customer-name" class="text-sm font-medium text-gray-300">Customer
                                    Name</label>
                                <input type="text" id="customer-name" required
                                    class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-base">
                            </div>
                            <div>
                                <label for="phone-number" class="text-sm font-medium text-gray-300">Phone Number
                                    (UK)</label>
                                <input type="tel" id="phone-number" placeholder="e.g. 07123 456789"
                                    class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-base">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="email-address" class="text-sm font-medium text-gray-300">Email Address
                                    (Optional)</label>
                                <input type="email" id="email-address"
                                    class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-base">
                            </div>
                            <div>
                                <label for="purchase-date" class="text-sm font-medium text-gray-300">Purchase
                                    Date</label>
                                <input type="date" id="purchase-date"
                                    class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-base">
                            </div>
                        </div>
                        <div>
                            <label for="product-details" class="text-sm font-medium text-gray-300">Product
                                Details</label>
                            <textarea id="product-details" rows="3"
                                class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-base"></textarea>
                        </div>
                        <div class="relative">
                            <label for="imei-number" class="text-sm font-medium text-gray-300">IMEI Number
                                (Mandatory)</label>
                            <input type="text" id="imei-number" required
                                class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-base pr-20">
                            <div class="absolute inset-y-0 right-0 top-6 flex items-center pr-3 space-x-2">
                                <button type="button" class="text-gray-400 hover:text-white"><svg
                                        xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M4.25 2A2.25 2.25 0 002 4.25v11.5A2.25 2.25 0 004.25 18h11.5A2.25 2.25 0 0018 15.75V4.25A2.25 2.25 0 0015.75 2H4.25zM6 7a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"
                                            clip-rule="evenodd" />
                                    </svg></button>
                                <button type="button" class="text-gray-400 hover:text-white"><svg
                                        xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z"
                                            clip-rule="evenodd" />
                                    </svg></button>
                            </div>
                        </div>
                        <div>
                            <label for="customer-address" class="text-sm font-medium text-gray-300">Customer Address
                                (Optional)</label>
                            <textarea id="customer-address" rows="3"
                                class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-base"></textarea>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
                            <div>
                                <label for="customer-id-proof" class="text-sm font-medium text-gray-300">Customer ID
                                    Proof (Optional)</label>
                                <div class="mt-1 flex items-center space-x-2">
                                    <input type="file" id="customer-id-proof"
                                        class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700"
                                        accept="image/*">
                                    <button type="button" onclick="openCamera()"
                                        class="p-2.5 bg-gray-600 rounded-md hover:bg-gray-500 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                            fill="currentColor">
                                            <path
                                                d="M2 4a1 1 0 011-1h1.5a1 1 0 01.98.804l1.32 4.62a1 1 0 01-.364 1.118l-1.132.85a12.182 12.182 0 005.37 5.37l.85-1.132a1 1 0 011.118-.364l4.62 1.32A1 1 0 0116 16.5V18a1 1 0 01-1 1H4a1 1 0 01-1-1V4z" />
                                        </svg>
                                    </button>
                                </div>
                                <img id="photo-preview" class="hidden mt-2 rounded-md max-h-24" />
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-300">Payment Method</label>
                                <div class="mt-2 flex space-x-4">
                                    <label class="flex items-center"><input type="radio" name="payment" value="cash"
                                            checked
                                            class="h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 focus:ring-purple-500"><span
                                            class="ml-2 text-sm">Cash</span></label>
                                    <label class="flex items-center"><input type="radio" name="payment" value="bank"
                                            class="h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 focus:ring-purple-500"><span
                                            class="ml-2 text-sm">Bank Transfer</span></label>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="purchase-amount" class="text-sm font-medium text-gray-300">Purchase Amount
                                (£)</label>
                            <input type="number" id="purchase-amount" value="0" step="any"
                                class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-base">
                        </div>
                        <button type="submit"
                            class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 focus:ring-offset-gray-900 transition-colors">
                            Add Purchase
                        </button>
                    </form>
                </div>

                <!-- Right Column: Info Cards -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <h3 class="font-semibold text-gray-300">Monthly Investment</h3>
                        <p class="text-sm text-gray-400">Total for September</p>
                        <p class="text-3xl font-bold mt-2">£0.00</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <h3 class="font-semibold text-gray-300">Upload Report</h3>
                        <p class="text-sm text-gray-400 mt-1 mb-2">Let the AI assistant parse your CSV file.</p>
                        <input type="file"
                            class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-gray-300 hover:file:bg-gray-600">
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <h3 class="font-semibold text-gray-300">Download Report</h3>
                        <p class="text-sm text-gray-400 mt-1 mb-4">Select a month and year to download the purchase
                            report.</p>
                        <form>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="purchase-download-year"
                                        class="text-sm font-medium text-gray-300">Year</label>
                                    <select id="purchase-download-year"
                                        class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-base"></select>
                                </div>
                                <div>
                                    <label for="purchase-download-month"
                                        class="text-sm font-medium text-gray-300">Month</label>
                                    <select id="purchase-download-month"
                                        class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-base"></select>
                                </div>
                            </div>
                            <button type="submit"
                                class="w-full flex items-center justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Download Report
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Recent Purchases Table -->
            <div class="mt-6 bg-gray-800 p-6 rounded-lg border border-gray-700">
                <h2 class="text-xl font-bold">Recent Purchases</h2>
                <div class="overflow-x-auto mt-4">
                    <table class="min-w-full text-sm text-left">
                        <thead class="border-b border-gray-700 text-gray-400">
                            <tr>
                                <th class="py-2 px-3 font-medium">Date</th>
                                <th class="py-2 px-3 font-medium">Customer</th>
                                <th class="py-2 px-3 font-medium">Product</th>
                                <th class="py-2 px-3 font-medium">IMEI/SN</th>
                                <th class="py-2 px-3 font-medium">Phone</th>
                                <th class="py-2 px-3 font-medium">Payment</th>
                                <th class="py-2 px-3 font-medium">Amount</th>
                                <th class="py-2 px-3 font-medium text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recent-purchases-tbody">
                            <!-- Purchase rows will be inserted here -->
                        </tbody>
                    </table>
                    <p id="no-purchases-message" class="text-center text-gray-500 py-8">No purchases yet.</p>
                </div>
            </div>
        </div>

        <!-- Camera Modal -->
        <div id="camera-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
            <div class="bg-gray-800 rounded-lg p-4 max-w-lg w-full relative">
                <video id="camera-stream" class="w-full rounded-md" autoplay playsinline></video>
                <canvas id="camera-canvas" class="hidden"></canvas>
                <div class="mt-4 flex justify-center space-x-4">
                    <button id="capture-btn"
                        class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700">Capture Photo</button>
                    <button onclick="closeCamera()"
                        class="bg-gray-600 text-white px-6 py-2 rounded-md hover:bg-gray-500">Cancel</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Store references to the page elements
        const pages = {
            'page-select-company': document.getElementById('page-select-company'),
            'page-select-branch': document.getElementById('page-select-branch'),
            'page-login': document.getElementById('page-login'),
            'page-signup': document.getElementById('page-signup'),
            'page-dashboard': document.getElementById('page-dashboard'),
            'page-sales-report': document.getElementById('page-sales-report'),
            'page-buy-products': document.getElementById('page-buy-products'),
            'page-buy-products-subcategory': document.getElementById('page-buy-products-subcategory'),
            'page-purchase-entry': document.getElementById('page-purchase-entry')
        };

        const loginTitle = document.getElementById('login-title');
        const loginIcon = document.getElementById('login-icon');
        const loginError = document.getElementById('login-error');
        const passwordInput = document.getElementById('password');

        // This object maps company names to their specific icons (as SVG strings)
        const companyIcons = {
            'TechPoint': `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-full h-full"><path stroke-linecap="round" stroke-linejoin="round" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V5m0 14v-1M9 6l1.293-1.293a1 1 0 011.414 0L12 6m0 12l1.293 1.293a1 1 0 001.414 0L15 18M9.75 12h4.5M12 9.75v4.5" /></svg>`,
            'TikTech': `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-full h-full"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 006 3.75v16.5a2.25 2.25 0 002.25 2.25h7.5A2.25 2.25 0 0018 20.25V3.75a2.25 2.25 0 00-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18h3" /></svg>`,
            'Restaurant': `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-full h-full"><path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.362-3.797z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214C16.317 4.209 17.587 3 19.5 3c2.21 0 4 1.79 4 4 0 1.913-.91 3.56-2.35 4.638M12 12.75h9" /></svg>`
        };

        // Defines the options for each product category
        const subCategories = {
            'Mobile Phones': ['iPhone', 'Android Phone'],
            'Tablets': ['iPad', 'Android Tablet'],
            'Laptops/Macbooks': ['Laptop', 'Macbook'],
            'PC and accessories': ['Windows PC', 'Mac', 'Accessories'],
        };

        let currentPurchaseCategory = ''; // To store the selected product type
        let recentPurchases = []; // To store purchase entry data
        let nextPurchaseId = 1;
        let cameraStream = null; // To hold the camera stream object

        // --- Core Navigation Logic ---
        function showPage(pageIdToShow) {
            // Hide all pages
            for (const pageId in pages) {
                pages[pageId].classList.add('hidden', 'opacity-0');
            }
            // Show the target page with a fade-in effect
            const pageToShow = pages[pageIdToShow];
            if (pageToShow) {
                pageToShow.classList.remove('hidden');
                // A tiny delay allows the 'display' property to update before starting the transition
                setTimeout(() => {
                    pageToShow.classList.remove('opacity-0');
                }, 10);
            }
            // Reset form states when navigating away
            loginError.classList.add('hidden');
            passwordInput.value = '';
            document.getElementById('signup-success').classList.add('hidden', 'opacity-0', '-translate-y-2');


            // Initialize the sales report page when it's shown
            if (pageIdToShow === 'page-sales-report') {
                initializeSalesReport();
            }

            // Initialize the purchase entry page when it's shown
            if (pageIdToShow === 'page-purchase-entry') {
                initializePurchaseEntryPage();
            }
        }

        // --- Page Interaction Logic ---

        // Called when a user clicks on a product category card
        function selectProductCategory(categoryName) {
            const subCategoryOptions = subCategories[categoryName];
            const subCategoryTitle = document.getElementById('subcategory-title');
            const subCategoryGrid = document.getElementById('subcategory-grid');

            // Clear previous options from the grid
            subCategoryGrid.innerHTML = '';

            // Check if this category has defined sub-categories
            if (subCategoryOptions) {
                subCategoryTitle.textContent = `What kind of ${categoryName.toLowerCase()}?`;

                // Create and add a card for each sub-category option
                subCategoryOptions.forEach(option => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 p-8 rounded-lg border border-gray-700 hover:bg-gray-700 hover:border-purple-500 cursor-pointer transition-all duration-300 flex items-center justify-center';
                    card.innerHTML = `<h3 class="font-semibold text-lg">${option}</h3>`;
                    card.onclick = () => selectSubCategory(categoryName, option);
                    subCategoryGrid.appendChild(card);
                });

                showPage('page-buy-products-subcategory');
            } else {
                // Fallback for categories without defined sub-categories (like Cameras or Other electronics)
                console.log(`Selected product category: ${categoryName}`);

                // Store the main category as the selected product type
                currentPurchaseCategory = categoryName;

                // Update the subtitle on the purchase entry form
                const subtitle = document.getElementById('purchase-entry-subtitle');
                subtitle.textContent = `Enter details of the product bought from a customer for category: ${categoryName}.`;

                // Show the final purchase entry page directly
                showPage('page-purchase-entry');
            }
        }

        // Called when a user clicks on a sub-category card (e.g., iPhone)
        function selectSubCategory(category, subCategory) {
            console.log(`Final Selection: ${category} -> ${subCategory}`);
            // Store the selection for when the form is submitted
            currentPurchaseCategory = subCategory;

            // Update the title on the purchase entry form
            const subtitle = document.getElementById('purchase-entry-subtitle');
            subtitle.textContent = `Enter details of the product bought from a customer for category: ${subCategory}.`;
            // Show the final purchase entry page
            showPage('page-purchase-entry');
        }

        // Called when a user clicks on a company card
        function selectCompany(companyName) {
            if (companyName === 'TikTech') {
                showPage('page-select-branch');
            } else {
                loginTitle.textContent = `Login to ${companyName}`;
                loginIcon.innerHTML = companyIcons[companyName] || '';
                showPage('page-login');
            }
        }

        // Called when a user selects a TikTech branch
        function selectBranch(branchName) {
            loginTitle.textContent = `Login to ${branchName}`;
            // Use the generic 'Building' icon for all branches
            loginIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-full h-full" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6M9 11.25h6M9 15.75h6" /></svg>`;
            showPage('page-login');
        }

        // Simulates a backend login check
        function handleLogin(event) {
            event.preventDefault(); // Prevents the form from reloading the page

            const email = event.target.email.value;
            const password = event.target.password.value;

            loginError.classList.add('hidden');

            // --- SIMULATED LOGIN ---
            // Try logging in with: m@example.com and password123
            if (email === 'm@example.com' && password === 'password123') {
                // Successful login
                showPage('page-dashboard');
            } else {
                // Failed login
                loginError.classList.remove('hidden');
            }
        }

        // Simulates a signup process
        function handleSignup(event) {
            event.preventDefault();
            const successMessage = document.getElementById('signup-success');

            // Show success message with animation
            successMessage.classList.remove('hidden');
            setTimeout(() => {
                successMessage.classList.remove('opacity-0', '-translate-y-2');
            }, 10);

            // After a delay, redirect to the login page
            setTimeout(() => {
                showPage('page-login');
            }, 2000); // 2-second delay
        }

        // --- New Purchase Entry Page Logic ---
        function initializePurchaseEntryPage() {
            // Set the purchase date to today by default
            const purchaseDateField = document.getElementById('purchase-date');
            if (!purchaseDateField.value) {
                purchaseDateField.value = new Date().toISOString().split('T')[0];
            }
            // Populate dropdowns for this page
            populateDateDropdowns('purchase-download-year', 'purchase-download-month');
            // Render the recent purchases table
            renderPurchaseTable();
        }

        function handlePurchaseEntry(event) {
            event.preventDefault();

            const newPurchase = {
                id: nextPurchaseId++,
                date: document.getElementById('purchase-date').value,
                customer: document.getElementById('customer-name').value,
                product: currentPurchaseCategory, // Use the stored category
                imei: document.getElementById('imei-number').value,
                phone: document.getElementById('phone-number').value,
                payment: document.querySelector('input[name="payment"]:checked').value,
                amount: parseFloat(document.getElementById('purchase-amount').value) || 0,
            };

            recentPurchases.unshift(newPurchase);
            renderPurchaseTable();

            console.log(`New purchase logged:`, newPurchase);

            // Reset the form for the next entry
            event.target.reset();
            document.getElementById('purchase-date').value = new Date().toISOString().split('T')[0]; // Reset date to today
            document.getElementById('photo-preview').classList.add('hidden');
        }

        function renderPurchaseTable() {
            const tbody = document.getElementById('recent-purchases-tbody');
            const noPurchasesMessage = document.getElementById('no-purchases-message');
            tbody.innerHTML = '';

            if (recentPurchases.length === 0) {
                noPurchasesMessage.classList.remove('hidden');
            } else {
                noPurchasesMessage.classList.add('hidden');
                recentPurchases.forEach(purchase => {
                    const formattedDate = new Date(purchase.date + 'T00:00:00').toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700 hover:bg-gray-700/50';
                    row.innerHTML = `
                        <td class="py-3 px-3">${formattedDate}</td>
                        <td class="py-3 px-3">${purchase.customer}</td>
                        <td class="py-3 px-3">${purchase.product}</td>
                        <td class="py-3 px-3">${purchase.imei}</td>
                        <td class="py-3 px-3">${purchase.phone}</td>
                        <td class="py-3 px-3 capitalize">${purchase.payment}</td>
                        <td class="py-3 px-3 font-semibold">£${purchase.amount.toFixed(2)}</td>
                        <td class="py-3 px-3 text-right">
                             <button onclick="deletePurchaseEntry(${purchase.id})" class="text-gray-500 hover:text-red-400 p-1 rounded-full transition-colors" title="Delete Purchase">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        function deletePurchaseEntry(purchaseId) {
            recentPurchases = recentPurchases.filter(p => p.id !== purchaseId);
            renderPurchaseTable();
        }

        // --- Camera Logic ---
        async function openCamera() {
            const modal = document.getElementById('camera-modal');
            const video = document.getElementById('camera-stream');

            try {
                // Request access to the user's camera
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = cameraStream;
                modal.classList.remove('hidden');
            } catch (err) {
                console.error("Error accessing camera: ", err);
                alert("Could not access the camera. Please ensure you have given permission.");
            }
        }

        function closeCamera() {
            const modal = document.getElementById('camera-modal');
            if (cameraStream) {
                // Stop all video tracks to turn off the camera light
                cameraStream.getTracks().forEach(track => track.stop());
            }
            modal.classList.add('hidden');
        }

        document.getElementById('capture-btn').addEventListener('click', () => {
            const canvas = document.getElementById('camera-canvas');
            const video = document.getElementById('camera-stream');
            const preview = document.getElementById('photo-preview');

            // Set canvas dimensions to match the video stream
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw the current video frame onto the canvas
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

            // Get the image data from the canvas
            const imageDataUrl = canvas.toDataURL('image/jpeg');

            // Display the captured image as a preview on the form
            preview.src = imageDataUrl;
            preview.classList.remove('hidden');

            // Close the camera modal
            closeCamera();
        });


        // --- Sales Report Page Logic (Simulated Backend) ---

        // This array acts as our in-memory database for sales.
        let salesData = [];
        let nextId = 1; // To give each sales entry a unique ID

        function initializeSalesReport() {
            // Set current date if not already set
            const dateField = document.getElementById('sales-date');
            if (dateField && !dateField.value) {
                dateField.value = new Date().toISOString().split('T')[0];
            }

            // Populate the "database" with initial data if it's empty
            if (salesData.length === 0) {
                salesData = [
                    { id: 1, date: '2025-09-09', cash: 250.00, techpoint: 125.50 },
                    { id: 2, date: '2025-09-08', cash: 180.25, techpoint: 90.00 },
                ];
                nextId = 3;
            }

            // Populate Year and Month dropdowns for this specific page
            populateDateDropdowns('monthly-total-year', 'monthly-total-month');
            populateDateDropdowns('download-monthly-year', 'download-monthly-month');
            populateDateDropdowns('download-yearly-year', null);

            // Render the progress chart with dummy data
            renderMonthlyTargetChart(75);
            // Render the sales table from our array
            renderSalesTable();
            // Ensure total is correct on page load
            updateDailyTotal();
        }

        function addSalesEntry(event) {
            event.preventDefault();
            const cashSalesInput = document.getElementById('cash-sales');
            const techpointSalesInput = document.getElementById('techpoint-sales');

            const newEntry = {
                id: nextId++, // Assign a new unique ID
                date: document.getElementById('sales-date').value,
                cash: parseFloat(cashSalesInput.value) || 0,
                techpoint: parseFloat(techpointSalesInput.value) || 0,
            };

            // Add the new entry to the start of our data array
            salesData.unshift(newEntry);

            // Re-render the table to show the change
            renderSalesTable();

            // Reset the form for the next entry
            cashSalesInput.value = '0';
            techpointSalesInput.value = '0';
            updateDailyTotal();
        }

        function deleteSalesEntry(entryId) {
            // Filter the array to remove the entry with the matching ID
            salesData = salesData.filter(entry => entry.id !== entryId);

            // Re-render the table
            renderSalesTable();
        }

        function renderSalesTable() {
            const tbody = document.getElementById('sales-entries-tbody');
            const noSalesMessage = document.getElementById('no-sales-message');
            if (!tbody || !noSalesMessage) return; // Safety check
            tbody.innerHTML = ''; // Clear existing rows

            // Sort data so the newest entries are always on top
            const sortedData = salesData.sort((a, b) => b.id - a.id);

            if (sortedData.length === 0) {
                noSalesMessage.classList.remove('hidden');
            } else {
                noSalesMessage.classList.add('hidden');
                sortedData.forEach(entry => {
                    const total = (entry.cash + entry.techpoint).toFixed(2);
                    const formattedDate = new Date(entry.date + 'T00:00:00').toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });

                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-800 hover:bg-gray-800/50';
                    row.innerHTML = `
                        <td class="py-3 px-3">${formattedDate}</td>
                        <td class="py-3 px-3">£${entry.cash.toFixed(2)}</td>
                        <td class="py-3 px-3">£${entry.techpoint.toFixed(2)}</td>
                        <td class="py-3 px-3 font-bold">£${total}</td>
                        <td class="py-3 px-3 text-right">
                            <button onclick="deleteSalesEntry(${entry.id})" class="text-gray-500 hover:text-red-400 p-1 rounded-full transition-colors" title="Delete Entry">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        // --- Helper & Static Functions ---

        function updateDailyTotal() {
            // FIX: Get elements fresh each time to avoid errors
            const cashSalesInput = document.getElementById('cash-sales');
            const techpointSalesInput = document.getElementById('techpoint-sales');
            const dailyTotalDisplay = document.getElementById('daily-total');

            if (cashSalesInput && techpointSalesInput && dailyTotalDisplay) {
                const cash = parseFloat(cashSalesInput.value) || 0;
                const techpoint = parseFloat(techpointSalesInput.value) || 0;
                const total = cash + techpoint;
                dailyTotalDisplay.textContent = `£${total.toFixed(2)}`;
            }
        }

        function populateDateDropdowns(yearSelectId, monthSelectId) {
            const yearSelect = document.getElementById(yearSelectId);
            const monthSelect = monthSelectId ? document.getElementById(monthSelectId) : null;

            if (!yearSelect) return; // Safely exit if the element isn't on the current page

            const currentYear = new Date().getFullYear();

            // Populate years if the dropdown is empty
            if (yearSelect.options.length === 0) {
                for (let i = 0; i < 5; i++) {
                    const year = currentYear - i;
                    yearSelect.add(new Option(year, year));
                }
            }
            yearSelect.value = '2025';

            if (!monthSelect) return; // Safely exit for elements without a month dropdown

            // Populate months if the dropdown is empty
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            if (monthSelect.options.length === 0) {
                months.forEach((month, index) => {
                    monthSelect.add(new Option(month, index + 1));
                });
            }
            monthSelect.value = '9'; // September
        }

        function renderMonthlyTargetChart(percentage) {
            const circle = document.getElementById('target-progress-circle');
            if (!circle) return; // Safety check
            const radius = circle.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;

            const offset = circumference - (percentage / 100) * circumference;

            circle.style.strokeDasharray = `${circumference} ${circumference}`;
            circle.style.strokeDashoffset = offset;
        }

        function handleAddMonthlyTotal(event) {
            event.preventDefault();
            const year = document.getElementById('monthly-total-year').value;
            const month = document.getElementById('monthly-total-month').value;
            const amount = document.getElementById('monthly-total-amount').value;

            console.log(`Adding monthly total for ${month}/${year}: £${amount}`);
            alert(`Monthly total of £${amount} for ${month}/${year} has been recorded in the console.`);
            document.getElementById('monthly-total-amount').value = '0';
        }

        function handleDownloadMonthlyReport(event) {
            event.preventDefault();
            const year = document.getElementById('download-monthly-year').value;
            const month = document.getElementById('download-monthly-month').value.padStart(2, '0');
            const monthName = document.getElementById('download-monthly-month').options[document.getElementById('download-monthly-month').selectedIndex].text;

            const reportData = salesData.filter(d => d.date.startsWith(`${year}-${month}`));

            if (reportData.length === 0) {
                alert(`No sales data found for ${monthName} ${year} to download.`);
                return;
            }

            let csvContent = "Date,Cash Sales,TechPoint Sales,Daily Total\n";
            reportData.forEach(row => {
                const total = (row.cash + row.techpoint).toFixed(2);
                csvContent += `${row.date},${row.cash.toFixed(2)},${row.techpoint.toFixed(2)},${total}\n`;
            });

            downloadCSV(csvContent, `monthly-report-${year}-${month}.csv`);
        }

        function handleDownloadYearlyReport(event) {
            event.preventDefault();
            const year = document.getElementById('download-yearly-year').value;

            const reportData = salesData.filter(d => d.date.startsWith(year));

            if (reportData.length === 0) {
                alert(`No sales data found for ${year} to download.`);
                return;
            }

            let csvContent = "Date,Cash Sales,TechPoint Sales,Daily Total\n";
            reportData.forEach(row => {
                const total = (row.cash + row.techpoint).toFixed(2);
                csvContent += `${row.date},${row.cash.toFixed(2)},${row.techpoint.toFixed(2)},${total}\n`;
            });

            downloadCSV(csvContent, `yearly-report-${year}.csv`);
        }

        function downloadCSV(csvContent, fileName) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

    </script>

    <style>
        /* Hides the default calendar icon so we can use our own SVG icon */
        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }

        /* Dark mode styling for date picker */
        input[type="date"] {
            color-scheme: dark;
        }
    </style>
</body>

</html>